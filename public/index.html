<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>Shopware Mobile Admin</title>
    <meta name="theme-color" content="#0a0a0a" />
    <style>
      :root {
        --bg: #0b0c0f;
        --card: #14161b;
        --muted: #8a8f98;
        --txt: #f5f7fb;
        --acc: #3aa0ff;
        --danger: #ff5555;
        --ok: #28c081;
        --radius: 18px;
        --pad: 14px;
        --gap: 12px;
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--txt);
        font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter,
          Ubuntu, sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      .app {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }
      header.nav {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(
          180deg,
          rgba(11, 12, 15, 0.95),
          rgba(11, 12, 15, 0.85)
        );
        backdrop-filter: blur(10px);
        padding: 12px 14px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      header.nav .row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
      }
      .logo .dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--ok);
        box-shadow: 0 0 18px var(--ok);
      }
      .search {
        flex: 1;
        display: flex;
        align-items: center;
        background: var(--card);
        border-radius: 999px;
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .search input {
        flex: 1;
        background: transparent;
        color: var(--txt);
        border: 0;
        outline: none;
        font: inherit;
      }
      .search button {
        background: transparent;
        border: 0;
        color: var(--muted);
      }

      main {
        flex: 1;
        padding: 10px 12px calc(76px + env(safe-area-inset-bottom));
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .card {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: var(--pad);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .row {
        display: flex;
        gap: 10px;
      }
      .between {
        justify-content: space-between;
        align-items: center;
      }
      .muted {
        color: var(--muted);
      }
      .pill {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .pill.ok {
        color: #0e2;
        color: inherit;
        background: rgba(40, 192, 129, 0.12);
        border-color: rgba(40, 192, 129, 0.25);
      }
      .pill.bad {
        color: #e33;
        background: rgba(255, 85, 85, 0.12);
        border-color: rgba(255, 85, 85, 0.25);
      }
      .price {
        font-weight: 700;
      }
      .thumb {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: #0a0b0e center/cover no-repeat;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .tabs {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 8px;
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
        background: linear-gradient(
          180deg,
          rgba(11, 12, 15, 0.1),
          rgba(11, 12, 15, 0.85)
        );
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }
      .tab {
        flex: 1;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 9px 8px;
        text-align: center;
        color: var(--muted);
      }
      .tab.active {
        color: var(--txt);
        outline: 2px solid rgba(58, 160, 255, 0.25);
      }

      .section-title {
        margin: 12px 4px 6px;
        font-size: 13px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .skeleton {
        position: relative;
        overflow: hidden;
        background: #0e1014;
        border-radius: 12px;
        height: 64px;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .skeleton::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.06),
          transparent
        );
        animation: shimmer 1.1s infinite;
      }
      @keyframes shimmer {
        to {
          transform: translateX(100%);
        }
      }

      .banner {
        margin: 12px;
        color: #ffca66;
        background: rgba(255, 202, 102, 0.12);
        border: 1px dashed rgba(255, 202, 102, 0.35);
        padding: 10px;
        border-radius: 12px;
      }

      /* Login */
      .login {
        min-height: 100dvh;
        display: grid;
        place-items: center;
        padding: 20px;
      }
      .wall {
        width: min(480px, 100%);
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 22px;
        box-shadow: var(--shadow);
        padding: 22px;
      }
      .wall h1 {
        margin: 0 0 6px;
      }
      .wall p {
        margin: 0 0 14px;
        color: var(--muted);
      }
      .field {
        display: flex;
        background: #0c0e12;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        overflow: hidden;
      }
      .field input {
        flex: 1;
        background: transparent;
        border: 0;
        outline: none;
        color: var(--txt);
        padding: 12px;
      }
      .field button {
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 0 12px;
      }
      .cta {
        width: 100%;
        margin-top: 12px;
        background: var(--acc);
        border: 0;
        color: white;
        font-weight: 700;
        padding: 13px;
        border-radius: 14px;
      }
      .err {
        color: var(--danger);
        font-size: 13px;
        margin-top: 6px;
      }

      /* Busy overlay */
      .busy {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(6px);
        z-index: 9999;
      }
      .busy .panel {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 14px 16px;
        box-shadow: var(--shadow);
      }
      .spinner {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        border: 3px solid rgba(255, 255, 255, 0.15);
        border-top-color: var(--acc);
        animation: spin 0.75s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      @media (min-width: 720px) {
        .desktop-info {
          display: block;
        }
      }
      @media (max-width: 719px) {
        .desktop-info {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- Login Wall -->
      <section class="login" id="login">
        <div style="position: relative; top: -80px; width: 300px">
          <img
            src="https://cobracards.loki.ambitive.de/media/5b/ae/5b/1754291920/Logo-CobraCards-Export-2.svg?ts=1754291920"
            width="200"
            height="auto"
            style="
              width: 200px;
              margin: 0 auto;
              display: block;
              margin-bottom: 40px;
            "
          />
          <div class="wall">
            <div class="row between" style="margin-bottom: 10px">
              <div class="logo">
                <span class="dot"></span><span>CC Admin</span>
              </div>
              <span class="muted" id="versionTag">v1</span>
            </div>
            <h1>Willkommen</h1>
            <p>Bitte Passwort eingeben, um das Shopware‚ÄëDashboard zu √∂ffnen.</p>
            <div class="field">
              <input
                id="password"
                type="password"
                placeholder="Passwort"
                autocomplete="current-password"
              />
              <button
                type="button"
                id="togglePw"
                aria-label="Passwort anzeigen"
              >
                üëÅÔ∏è
              </button>
            </div>
            <button class="cta" id="loginBtn">Anmelden</button>
            <div
              class="err"
              id="loginErr"
              role="alert"
              style="display: none"
            ></div>
          </div>
        </div>
      </section>

      <!-- App Shell -->
      <section id="shell" style="display: none">
        <header class="nav">
          <div class="row between">
            <div class="logo">
              <span class="dot"></span><span>CC Admin</span>
            </div>
            <div class="search" role="search">
              <input
                id="q"
                placeholder="Produkte, Bestellungen, Kunden suchen‚Ä¶"
                inputmode="search"
              />
              <button id="qClear" aria-label="L√∂schen">‚úï</button>
            </div>
          </div>
        </header>

        <main>
          <div id="route"></div>
        </main>

        <nav class="tabs" role="tablist" aria-label="Main">
          <button class="tab active" data-tab="products" aria-selected="true">
            üõçÔ∏è
            <div>Produkte</div>
          </button>
          <button class="tab" data-tab="orders">
            üßæ
            <div>Bestellungen</div>
          </button>
          <button class="tab" data-tab="customers">
            üë§
            <div>Kunden</div>
          </button>
          <button class="tab" data-tab="settings">
            ‚öôÔ∏è
            <div>Einstellungen</div>
          </button>
        </nav>
      </section>
      <!-- Busy overlay -->
      <div id="busy" class="busy" role="alert" aria-live="polite" aria-busy="true" style="display:none">
        <div class="panel">
          <div class="spinner" aria-hidden="true"></div>
          <div id="busyText">Bitte warten‚Ä¶</div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const $ = (sel) => document.querySelector(sel);
        const routeEl = $("#route");
        const tabs = document.querySelectorAll(".tab");

        const state = {
          tab: "products",
          q: "",
          pages: { products: 1, orders: 1, customers: 1 },
          loading: false,
          done: { products: false, orders: false, customers: false },
          searchMode: false,
          features: { invoiceActions: true },
        };

        const api = {
          async me() {
            try {
              const r = await fetch("/api/me");
              return await r.json();
            } catch (e) {
              return { ok: false };
            }
          },
          async login(password) {
            const r = await fetch("/api/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password }),
            });
            if (!r.ok) throw new Error("Ung√ºltiges Passwort");
            return r.json();
          },
          async logout() {
            await fetch("/api/logout", { method: "POST" });
          },
          async list(kind, { page = 1, limit = 20, q = "" }) {
            const params = new URLSearchParams({ page, limit, q });
            const r = await fetch(`/api/${kind}?` + params);
            if (r.status === 401) {
              showLogin();
              return { data: [], total: 0 };
            }
            if (!r.ok) throw new Error("Laden fehlgeschlagen");
            return await r.json();
          },
          async product(id) {
            const r = await fetch(`/api/products/${id}`);
            if (!r.ok) throw new Error("Nicht gefunden");
            return await r.json();
          },
          async order(id) {
            const r = await fetch(`/api/orders/${id}`);
            if (!r.ok) throw new Error("Nicht gefunden");
            return await r.json();
          },
          async ordersMetrics() {
            const r = await fetch(`/api/orders/metrics`);
            if (!r.ok) throw new Error("Laden fehlgeschlagen");
            return await r.json();
          },
          async customer(id) {
            const r = await fetch(`/api/customers/${id}`);
            if (!r.ok) throw new Error("Nicht gefunden");
            return await r.json();
          },
          async customerOrders(id, { page = 1, limit = 20 } = {}) {
            const params = new URLSearchParams({ page, limit });
            const r = await fetch(`/api/customers/${id}/orders?` + params);
            if (!r.ok) throw new Error("Failed to load");
            return await r.json();
          },
          async paymentMethods({ page = 1, limit = 100, q = "" } = {}) {
            const params = new URLSearchParams({ page, limit, q });
            const r = await fetch(`/api/payment-methods?` + params);
            if (!r.ok) throw new Error("Failed to load payment methods");
            return await r.json();
          },
          async countries({ page = 1, limit = 250, q = "" } = {}) {
            const params = new URLSearchParams({ page, limit, q });
            const r = await fetch(`/api/countries?` + params);
            if (!r.ok) throw new Error("Failed to load countries");
            return await r.json();
          },
          async shippingMethods({ page = 1, limit = 100, q = "" } = {}) {
            const params = new URLSearchParams({ page, limit, q });
            const r = await fetch(`/api/shipping-methods?` + params);
            if (!r.ok) throw new Error("Failed to load shipping methods");
            return await r.json();
          },
          async salutations() {
            const r = await fetch(`/api/salutations`);
            if (!r.ok) throw new Error("Failed to load salutations");
            return await r.json();
          },
          async createOrder(payload) {
            const r = await fetch(`/api/orders`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            return await r.json();
          },
          async features() {
            const r = await fetch(`/api/features`);
            if (!r.ok) return { invoiceActions: true };
            return await r.json();
          },
        };

        // Busy overlay helpers
        function showBusy(msg) {
          const el = document.getElementById("busy");
          if (!el) return;
          const t = document.getElementById("busyText");
          if (t) t.textContent = msg || "Bitte warten‚Ä¶";
          el.style.display = "grid";
        }
        function hideBusy() {
          const el = document.getElementById("busy");
          if (!el) return;
          el.style.display = "none";
        }

        // UI helpers
        function setTab(tab) {
          state.tab = tab;
          tabs.forEach((t) =>
            t.classList.toggle("active", t.dataset.tab === tab)
          );
          routeEl.innerHTML = "";
          state.pages[tab] = 1;
          state.done[tab] = false;
          if (state.q && state.q.length > 0) {
            state.searchMode = true;
            renderListSkeleton();
            doGlobalSearch();
          } else {
            state.searchMode = false;
            renderListSkeleton();
            loadMore();
          }
        }

        function renderListSkeleton() {
          const wrap = document.createElement("div");
          wrap.className = "list";
          for (let i = 0; i < 8; i++) {
            const s = document.createElement("div");
            s.className = "skeleton";
            wrap.appendChild(s);
          }
          routeEl.innerHTML = "";
          routeEl.appendChild(wrap);
        }

        function el(tag, cls, html) {
          const e = document.createElement(tag);
          if (cls) e.className = cls;
          if (html !== undefined) e.innerHTML = html;
          return e;
        }

        function money(n, c = "‚Ç¨") {
          if (n == null) return "";
          return new Intl.NumberFormat(undefined, {
            style: "currency",
            currencyDisplay: "symbol",
            currency: "EUR",
          }).format(n);
        }

        function productItem(p) {
          const card = el("div", "card");
          const row = el("div", "row between");
          const left = el("div", "row");
          const img = el("div", "thumb");
          if (p.img) img.style.backgroundImage = `url("${p.img}")`;
          left.appendChild(img);
          const info = el("div");
          info.innerHTML = `<div style="font-weight:600"><p style="margin:0;margin: 0;
    max-width: 190px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;">${
      p.name || "(kein Name)"
    }</p><p class="muted" style="margin:0px">#${p.productNumber || ""}</p></div>
      <div class="muted" style="font-size:13px">${p.manufacturer || "‚Äî"}</div>`;
          left.appendChild(info);
          const right = el("div", "row");
          right.style.alignItems = "end";
          right.style.flexDirection = "column";
          const price = el("div", "price", p.price ? money(p.price) : "");
          const stock = el(
            "div",
            "pill " + (p.active ? "ok" : "bad"),
            p.active ? `Auf Lager: ${p.stock}` : "Inaktiv"
          );
          right.append(price, stock);
          row.append(left, right);
          card.appendChild(row);
          card.addEventListener("click", () => openProduct(p.id));
          return card;
        }

        function orderItem(o) {
          const card = el("div", "card");
          card.innerHTML = `<div class="row between">
      <div>
        <div style="font-weight:600">Bestellung #${o.orderNumber}</div>
        <div class="muted" style="font-size:13px">${new Date(
          o.createdAt
        ).toLocaleString()} ‚Ä¢ ${o.customerEmail || ""}</div>
      </div>
      <div style="text-align:right">
        <div class="price">${money(o.amountTotal)}</div>
        <div class="pill ${o.stateColor || "ok"}">${o.state || "‚Äî"}</div>
      </div>
    </div>`;
          card.addEventListener("click", () => openOrder(o.id));
          return card;
        }

        function customerItem(c) {
          const card = el("div", "card");
          card.innerHTML = `<div class="row between">
      <div>
        <div style="font-weight:600">${c.firstName || ""} ${
            c.lastName || ""
          }</div>
        <div class="muted" style="font-size:13px">${c.email || ""}</div>
      </div>
      <div class="pill ${c.active ? "ok" : "bad"}">${
            c.active ? "Aktiv" : "Inaktiv"
          }</div>
    </div>`;
          card.addEventListener("click", () => openCustomer(c.id));
          return card;
        }

        async function openProduct(id) {
          routeEl.innerHTML = "";
          routeEl.appendChild(el("div", "skeleton"));
          try {
            const { data: p } = await api.product(id);
            const card = el("div", "card");
            card.innerHTML = `
        <div class="row" style="gap:14px">
          <div class="thumb" style="width:100px;height:100px;background-size:cover;${
            p.img ? `background-image:url('${p.img}')` : ""
          }"></div>
          <div>
            <div style="font-weight:700;font-size:18px">${
              p.name || "(kein Name)"
            } </div>
            <div class="muted" style="margin-top:2px">#${
              p.productNumber || ""
            }</div>
            <div class="row" style="margin-top:8px;gap:8px">
              <div class="pill ${p.active ? "ok" : "bad"}">${
              p.active ? "Aktiv" : "Inaktiv"
            }</div>
              <div class="pill">Bestand: ${p.stock ?? "‚Äî"}</div>
            </div>
          </div>
        </div>
        <div class="row between" style="margin-top:12px">
          <div>
            <div class="muted">Hersteller</div>
            <div>${p.manufacturer || "‚Äî"}</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Preis</div>
            <div class="price">${p.price ? money(p.price) : "‚Äî"}</div>
          </div>
        </div>
      `;
            const back = el("button", "cta");
            back.textContent = "‚Üê Zur√ºck";
            back.style.marginTop = "12px";
            back.addEventListener("click", () => setTab("products"));
            routeEl.innerHTML = "";
            routeEl.append(card, back);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Produkt konnte nicht geladen werden.</div>`;
          }
        }

        async function openOrder(id) {
          routeEl.innerHTML = "";
          routeEl.appendChild(el("div", "skeleton"));
          try {
            const { data: o } = await api.order(id);
            const card = el("div", "card");
            const items = (o.items || [])
              .map(
                (i) => `<div class="row between" style="margin-top:8px">
          <div class="row" style="gap:8px;align-items:center">
            <div class="thumb" style="width:44px;height:44px;${
              i.img ? `background-image:url('${i.img}')` : ""
            }"></div>
            <div>${i.label || ""}</div>
          </div>
          <div class="muted">x${i.qty || 1}</div>
        </div>`
              )
              .join("");
            const paidPill = `<span class="pill ${o.paid ? "ok" : "bad"}">${
              o.paid ? "Bezahlt" : o.paidState || "Unbezahlt"
            }</span>`;
            const shippedPill = `<span class="pill ${
              o.shipped ? "ok" : "bad"
            }">${
              o.shipped ? "Versendet" : o.shippedState || "Nicht versendet"
            }</span>`;
            card.innerHTML = `
        <div class="row between">
          <div>
            <div style="font-weight:700">Bestellung #${o.orderNumber}</div>
            <div class="muted" style="font-size:13px">${new Date(
              o.createdAt
            ).toLocaleString()} ‚Ä¢ ${o.customerEmail || ""}</div>
          </div>
          <div style="text-align:right">
            <div class="pill ${o.stateColor || "ok"}">${o.state || "‚Äî"}</div>
            <div class="price">${money(o.amountTotal)}</div>
          </div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">${paidPill}${shippedPill}</div>
        <div style="margin-top:10px">${
          items || '<div class="muted">Keine Positionen</div>'
        }</div>
      `;
            const buttons = el("div", "row");
            buttons.style.flexWrap = "wrap";
            buttons.style.gap = "8px";
            buttons.style.marginTop = "12px";
            if (state.features.invoiceActions) {
              const invoiceBtn = el("button", "cta");
              invoiceBtn.textContent = "Rechnung erstellen";
              invoiceBtn.addEventListener("click", async () => {
                try {
                  showBusy("Rechnung wird erstellt‚Ä¶");
                  invoiceBtn.disabled = true;
                  const old = invoiceBtn.textContent;
                  invoiceBtn.textContent = "Erstelle‚Ä¶";
                  const r = await fetch(`/api/orders/${id}/invoice`, { method: "POST" });
                  if (!r.ok) {
                    const t = await r.text();
                    throw new Error(t.includes("403") ? "Aktion vom Server blockiert (nginx 403)." : "Fehler beim Erstellen");
                  }
                  const j = await r.json();
                  invoiceBtn.textContent = "Rechnung herunterladen";
                  invoiceBtn.disabled = false;
                  if (j && j.downloadUrl) window.open(j.downloadUrl, "_blank");
                } catch (e) {
                  invoiceBtn.disabled = false;
                  invoiceBtn.textContent = "Rechnung erstellen";
                  alert(String(e.message || e) + "\nBitte /api/_action in Nginx freischalten oder diese Funktion deaktivieren.");
                } finally {
                  hideBusy();
                }
              });

              const invoiceMailBtn = el("button", "cta");
              invoiceMailBtn.textContent =
                "Rechnung erstellen und an den Kunden senden";
              invoiceMailBtn.addEventListener("click", async () => {
                try {
                  showBusy("Rechnung wird erstellt und versendet‚Ä¶");
                  invoiceMailBtn.disabled = true;
                  const old = invoiceMailBtn.textContent;
                  invoiceMailBtn.textContent = "Sende‚Ä¶";
                  const r = await fetch(`/api/orders/${id}/invoice-email`, { method: "POST" });
                  if (!r.ok) {
                    const t = await r.text();
                    throw new Error(t.includes("403") ? "Aktion vom Server blockiert (nginx 403)." : "Fehler beim Senden");
                  }
                  await r.json();
                  invoiceMailBtn.textContent = "Gesendet";
                  setTimeout(() => { invoiceMailBtn.textContent = old; invoiceMailBtn.disabled = false; }, 1500);
                } catch (e) {
                  invoiceMailBtn.disabled = false;
                  alert(String(e.message || e) + "\nBitte /api/_action in Nginx freischalten oder diese Funktion deaktivieren.");
                } finally {
                  hideBusy();
                }
              });
              buttons.appendChild(invoiceBtn);
              buttons.appendChild(invoiceMailBtn);
            }

            const back = el("button", "cta");
            back.textContent = "‚Üê Zur√ºck";
            back.addEventListener("click", () => setTab("orders"));
            if (o.customerId) {
              const toCustomer = el("button", "cta");
              toCustomer.textContent = "Zum Kunden";
              toCustomer.addEventListener("click", () =>
                openCustomer(o.customerId)
              );
              buttons.appendChild(toCustomer);
            }
            buttons.appendChild(back);
            routeEl.innerHTML = "";
            routeEl.append(card, buttons);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Bestellung konnte nicht geladen werden.</div>`;
          }
        }

        async function openCustomer(id) {
          routeEl.innerHTML = "";
          routeEl.appendChild(el("div", "skeleton"));
          try {
            const { data: c } = await api.customer(id);
            const card = el("div", "card");
            card.innerHTML = `
        <div class="row between">
          <div>
            <div style="font-weight:700">${c.firstName || ""} ${
              c.lastName || ""
            }</div>
            <div class="muted" style="font-size:13px">${c.email || ""}</div>
          </div>
          <div class="pill ${c.active ? "ok" : "bad"}">${
              c.active ? "Active" : "Inactive"
            }</div>
        </div>
        <div class="row between" style="margin-top:12px">
          <div class="muted">Customer #</div>
          <div>${c.customerNumber || "‚Äî"}</div>
        </div>
        <div class="row between" style="margin-top:6px">
          <div class="muted">Created</div>
          <div>${
            c.createdAt ? new Date(c.createdAt).toLocaleString() : "‚Äî"
          }</div>
        </div>
      `;
            const ordersWrap = el("div", "card");
            ordersWrap.innerHTML = `<div class="section-title">Bestellungen</div>`;
            const list = el("div", "list");
            ordersWrap.appendChild(list);
            // Load orders list
            try {
              const { data: orders } = await api.customerOrders(id, {
                page: 1,
                limit: 50,
              });
              if (orders.length === 0) {
                list.appendChild(
                  el("div", "muted", "Noch keine Bestellungen.")
                );
              } else {
                orders.forEach((o) => list.appendChild(orderItem(o)));
              }
            } catch (e) {
              list.appendChild(
                el("div", "muted", "Bestellungen konnten nicht geladen werden.")
              );
            }

            const back = el("button", "cta");
            back.textContent = "‚Üê Zur√ºck";
            back.style.marginTop = "12px";
            back.addEventListener("click", () => setTab("customers"));
            routeEl.innerHTML = "";
            routeEl.append(card, ordersWrap, back);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Kunde konnte nicht geladen werden.</div>`;
          }
        }

        async function loadMore() {
          if (state.searchMode) return;
          if (state.loading || state.done[state.tab]) return;
          state.loading = true;
          try {
            const page = state.pages[state.tab];
            const { data, total } = await api.list(state.tab, {
              page,
              limit: 20,
              q: state.q,
            });
            let list = routeEl.querySelector(".list");
            if (!list) {
              list = el("div", "list");
              routeEl.innerHTML = "";
              routeEl.appendChild(list);
            }
            // Ensure metrics and quick-create cards exist for orders
            if (
              state.tab === "orders" &&
              !document.getElementById("orderMetrics")
            ) {
              const m = el("div", "card");
              m.id = "orderMetrics";
              m.innerHTML = `
                <div class="section-title">Kennzahlen</div>
                <div class="row" style="gap:8px;flex-wrap:wrap">
                  <div class="pill" id="mToday">Heute: ‚Ä¶</div>
                  <div class="pill" id="m7">Letzte 7 Tage: ‚Ä¶</div>
                  <div class="pill" id="m30">Letzte 30 Tage: ‚Ä¶</div>
                  <div class="pill" id="mYear">Dieses Jahr: ‚Ä¶</div>
                </div>`;
              m.style.marginBottom = "12px";
              routeEl.insertBefore(m, list);
              // Quick create button
              const qc = el("div", "card");
              qc.id = "orderCreate";
              const btn = el("button", "cta");
              btn.textContent = "Neue Bestellung";
              btn.addEventListener("click", openCreateOrder);
              qc.appendChild(btn);
              qc.style.marginBottom = "12px";
              routeEl.insertBefore(qc, list);
              // Load metrics async
              api
                .ordersMetrics()
                .then(({ today, last7, last30, thisYear }) => {
                  const set = (id, txt) => {
                    const n = document.getElementById(id);
                    if (n) n.textContent = txt;
                  };
                  const fmt = (m) => `${m.count} ‚Ä¢ ${money(m.amount)}`;
                  set("mToday", `Heute: ${fmt(today)}`);
                  set("m7", `Letzte 7 Tage: ${fmt(last7)}`);
                  set("m30", `Letzte 30 Tage: ${fmt(last30)}`);
                  set("mYear", `Dieses Jahr: ${fmt(thisYear)}`);
                })
                .catch(() => {
                  const n = document.getElementById("orderMetrics");
                  if (n) n.style.display = "none";
                });
            }
            // Clear skeletons on first real data load
            const sk = list.querySelector(".skeleton");
            if (sk) list.innerHTML = "";
            if (state.tab === "products") {
              data.forEach((p) => list.appendChild(productItem(p)));
            }
            if (state.tab === "orders") {
              data.forEach((o) => list.appendChild(orderItem(o)));
            }
            if (state.tab === "customers") {
              data.forEach((c) => list.appendChild(customerItem(c)));
            }
            const soFar = page * 20;
            if (soFar >= total || data.length === 0) {
              state.done[state.tab] = true;
            } else {
              state.pages[state.tab]++;
            }
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Fehler beim Laden der Daten.</div>`;
          } finally {
            state.loading = false;
          }
        }

        // Create Order UI
        function openCreateOrder() {
          const createState = {
            existing: true,
            customerId: null,
            customerPick: null,
            customerQuery: "",
            customerResults: [],
            guest: {
              email: "",
              firstName: "",
              lastName: "",
              billing: { street: "", zipcode: "", city: "", countryId: "" },
              shippingSame: true,
              shipping: { street: "", zipcode: "", city: "", countryId: "" },
            },
            paymentMethodId: null,
            pmList: [],
            countries: [],
            items: [], // {productId, productNumber, name, qty}
            productQuery: "",
            productResults: [],
            busy: false,
            err: "",
          };

          routeEl.innerHTML = "";
          const wrap = el("div");

          // Header
          const head = el("div", "card");
          head.innerHTML = `<div style="font-weight:700">Neue Bestellung</div>`;
          wrap.appendChild(head);

          // Customer section
          const cust = el("div", "card");
          cust.innerHTML = `
            <div class="section-title">Kunde</div>
            <div class="row" style="gap:12px;flex-wrap:wrap">
              <label><input type="radio" name="custMode" value="existing" checked> Bestehender Kunde</label>
              <label><input type="radio" name="custMode" value="guest"> Gast</label>
            </div>
            <div id="custExisting">
              <div class="field" style="margin-top:8px">
                <input id="custQ" placeholder="Kunde suchen (Name, Email, Nr.)" />
                <button type="button">üîé</button>
              </div>
              <div id="custResults" class="list" style="margin-top:8px"></div>
              <div id="custPicked" class="muted" style="margin-top:6px"></div>
            </div>
            <div id="custGuest" style="display:none;margin-top:8px">
              <div class="field" style="margin-bottom:6px">
                <select id="gSalutation"></select>
              </div>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <div class="field" style="flex:1"><input id="gEmail" placeholder="E‚ÄëMail" /></div>
                <div class="field" style="flex:1"><input id="gFirst" placeholder="Vorname" /></div>
                <div class="field" style="flex:1"><input id="gLast" placeholder="Nachname" /></div>
              </div>
              <div class="section-title" style="margin-top:10px">Rechnungsadresse</div>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <div class="field" style="flex:2"><input id="gBStreet" placeholder="Stra√üe" /></div>
                <div class="field" style="flex:1"><input id="gBZip" placeholder="PLZ" /></div>
                <div class="field" style="flex:2"><input id="gBCity" placeholder="Stadt" /></div>
              </div>
              <div class="field" style="margin-top:6px">
                <select id="gBCountry"></select>
              </div>
              <label style="display:block;margin-top:8px"><input id="gSame" type="checkbox" checked> Lieferadresse = Rechnungsadresse</label>
              <div id="shipBlock" style="display:none">
                <div class="section-title" style="margin-top:10px">Lieferadresse</div>
                <div class="row" style="gap:8px;flex-wrap:wrap">
                  <div class="field" style="flex:2"><input id="gSStreet" placeholder="Stra√üe" /></div>
                  <div class="field" style="flex:1"><input id="gSZip" placeholder="PLZ" /></div>
                  <div class="field" style="flex:2"><input id="gSCity" placeholder="Stadt" /></div>
                </div>
                <div class="field" style="margin-top:6px">
                  <select id="gSCountry"></select>
                </div>
              </div>
            </div>
          `;
          wrap.appendChild(cust);

          // Payment section
          const pay = el("div", "card");
          pay.style.margin = "10px 0";
          pay.innerHTML = `<div class="section-title">Zahlung & Versand</div>
            <div class="muted" style="margin-bottom:6px">Zahlungsmethode</div>
            <div id="pmList" class="list" style="margin-bottom:10px"></div>
            <div class="muted" style="margin-bottom:6px">Versandart</div>
            <div id="smList" class="list"></div>
            <div class="row" style="gap:8px;margin-top:8px">
              <div class="field" style="flex:1"><input id="shipPrice" inputmode="decimal" placeholder="Versandkosten (z.B. 4.90)" /></div>
            </div>`;
          wrap.appendChild(pay);

          // Products section
          const prod = el("div", "card");
          prod.style.margin = "0 10px 0 0";
          prod.innerHTML = `
            <div class="section-title">Produkte</div>
            <div class="field"><input id="pQ" placeholder="Produkte suchen‚Ä¶" /></div>
            <div id="pResults" class="list" style="margin-top:8px"></div>
            <div class="section-title" style="margin-top:10px">Warenkorb</div>
            <div id="cart" class="list"></div>
            <div class="row between" style="margin-top:8px">
              <div class="muted">Summe</div>
              <div id="sum" class="price">0,00¬†‚Ç¨</div>
            </div>
          `;
          wrap.appendChild(prod);

          // Actions
          const actions = el("div", "card");
          actions.style.margin = "10px 0";
          const createBtn = el("button", "cta");
          createBtn.textContent = "Bestellung anlegen";
          const backBtn = el("button", "cta");
          backBtn.textContent = "‚Üê Abbrechen";
          actions.append(createBtn, backBtn);
          const errBox = el("div", "err");
          errBox.style.marginTop = "8px";
          errBox.style.display = "none";
          actions.appendChild(errBox);
          wrap.appendChild(actions);

          routeEl.appendChild(wrap);

          // Helpers
          const fmtMoney = (n) =>
            new Intl.NumberFormat(undefined, {
              style: "currency",
              currency: "EUR",
            }).format(n || 0);
          function recompute() {
            const sumItems = createState.items.reduce(
              (a, it) => a + Number(it.price || 0) * it.qty,
              0
            );
            const ship =
              parseFloat(document.getElementById("shipPrice")?.value || "0") ||
              0;
            const sum = sumItems + ship;
            document.getElementById("sum").textContent = fmtMoney(sum);
            const cart = document.getElementById("cart");
            cart.innerHTML = "";
            if (createState.items.length === 0)
              cart.appendChild(el("div", "muted", "Keine Positionen."));
            createState.items.forEach((it) => {
              const row = el("div", "row between");
              row.innerHTML = `<div>${
                it.name || it.productNumber || it.productId
              }</div>`;
              const ctrls = el("div", "row");
              const minus = el("button", "cta");
              minus.textContent = "‚àí";
              const qty = el("div");
              qty.style.minWidth = "28px";
              qty.style.textAlign = "center";
              qty.textContent = String(it.qty);
              const plus = el("button", "cta");
              plus.textContent = "+";
              minus.addEventListener("click", () => {
                it.qty = Math.max(1, (it.qty || 1) - 1);
                recompute();
              });
              plus.addEventListener("click", () => {
                it.qty = (it.qty || 1) + 1;
                recompute();
              });
              const del = el("button", "cta");
              del.textContent = "‚úï";
              del.addEventListener("click", () => {
                createState.items = createState.items.filter((x) => x !== it);
                recompute();
              });
              ctrls.append(minus, qty, plus, del);
              row.appendChild(ctrls);
              cart.appendChild(row);
            });
          }

          async function loadPaymentMethods() {
            try {
              const { data } = await api.paymentMethods();
              createState.pmList = data || [];
              const list = document.getElementById("pmList");
              list.innerHTML = "";
              if (!createState.pmList.length) {
                list.appendChild(
                  el("div", "muted", "Keine Zahlungsmethoden gefunden.")
                );
              } else {
                createState.pmList.forEach((pm, idx) => {
                  const row = el("label");
                  row.style.display = "block";
                  row.style.padding = "6px 0";
                  const inp = document.createElement("input");
                  inp.type = "radio";
                  inp.name = "pm";
                  inp.value = pm.id;
                  if (idx === 0) {
                    inp.checked = true;
                    createState.paymentMethodId = pm.id;
                  }
                  inp.addEventListener(
                    "change",
                    () => (createState.paymentMethodId = pm.id)
                  );
                  row.appendChild(inp);
                  row.append(" ", pm.name || pm.id);
                  list.appendChild(row);
                });
              }
            } catch {}
          }

          async function loadCountries() {
            try {
              const { data } = await api.countries({ limit: 250 });
              createState.countries = data || [];
              const opts = [el("option", "", "Land ausw√§hlen")];
              createState.countries.forEach((c) => {
                const o = document.createElement("option");
                o.value = c.id;
                o.textContent = c.name;
                opts.push(o);
              });
              const bSel = document.getElementById("gBCountry");
              const sSel = document.getElementById("gSCountry");
              bSel.innerHTML = "";
              sSel.innerHTML = "";
              opts.forEach((o) => {
                bSel.appendChild(o.cloneNode(true));
                sSel.appendChild(o.cloneNode(true));
              });
            } catch {}
          }

          async function loadShippingMethods() {
            try {
              const { data } = await api.shippingMethods();
              const list = document.getElementById("smList");
              list.innerHTML = "";
              if (!data || !data.length) {
                list.appendChild(
                  el("div", "muted", "Keine Versandarten gefunden.")
                );
                return;
              }
              data.forEach((sm, idx) => {
                const row = el("label");
                row.style.display = "block";
                row.style.padding = "6px 0";
                const inp = document.createElement("input");
                inp.type = "radio";
                inp.name = "sm";
                inp.value = sm.id;
                if (idx === 0) inp.checked = true;
                inp.addEventListener(
                  "change",
                  () => (createState.shippingMethodId = sm.id)
                );
                row.appendChild(inp);
                row.append(" ", sm.name || sm.id);
                list.appendChild(row);
                if (idx === 0) createState.shippingMethodId = sm.id;
              });
            } catch {}
          }

          async function loadSalutations() {
            try {
              const { data } = await api.salutations();
              const sel = document.getElementById("gSalutation");
              if (!sel) return;
              sel.innerHTML = "";
              const makeOpt = (id, label) => { const o = document.createElement("option"); o.value = id; o.textContent = label; return o; };
              (data || []).forEach(s => sel.appendChild(makeOpt(s.id, s.name || s.key || s.letterName || s.id)));
              // Prefer not_specified, then mr, else first
              const preferred = (data || []).find(s => s.key === 'not_specified') || (data || []).find(s => s.key === 'mr') || (data || [])[0];
              if (preferred) sel.value = preferred.id;
              createState.guest.salutationId = sel.value || null;
              sel.addEventListener('change', (e) => (createState.guest.salutationId = e.target.value));
            } catch {}
          }

          async function searchCustomers(q) {
            const { data } = await api.list("customers", {
              page: 1,
              limit: 10,
              q,
            });
            createState.customerResults = data || [];
            const res = document.getElementById("custResults");
            res.innerHTML = "";
            (createState.customerResults || []).forEach((c) => {
              const item = el("div", "row between");
              item.style.padding = "6px";
              item.style.border = "1px solid rgba(255,255,255,0.06)";
              item.style.borderRadius = "10px";
              item.innerHTML = `<div>${c.firstName || ""} ${
                c.lastName || ""
              }<div class="muted" style="font-size:12px">${
                c.email || ""
              }</div></div>`;
              const pick = el("button", "cta");
              pick.textContent = "W√§hlen";
              pick.addEventListener("click", () => {
                createState.customerId = c.id;
                createState.customerPick = c;
                document.getElementById("custPicked").textContent = `Gew√§hlt: ${
                  c.firstName || ""
                } ${c.lastName || ""} <${c.email || ""}>`;
              });
              item.appendChild(pick);
              res.appendChild(item);
            });
          }

          async function searchProducts(q) {
            const { data } = await api.list("products", {
              page: 1,
              limit: 10,
              q,
            });
            createState.productResults = data || [];
            const res = document.getElementById("pResults");
            res.innerHTML = "";
            (createState.productResults || []).forEach((p) => {
              const item = el("div", "row between");
              item.style.padding = "6px";
              const left = el("div");
              left.innerHTML = `<div>${
                p.name || p.productNumber
              }</div><div class="muted" style="font-size:12px">${
                p.productNumber || ""
              }</div>`;
              const add = el("button", "cta");
              add.textContent = "Hinzuf√ºgen";
              add.addEventListener("click", () => {
                const existing = createState.items.find(
                  (x) => x.productId === p.id
                );
                if (existing) existing.qty += 1;
                else
                  createState.items.push({
                    productId: p.id,
                    productNumber: p.productNumber,
                    name: p.name,
                    qty: 1,
                    price: p.price,
                  });
                recompute();
              });
              item.append(left, add);
              res.appendChild(item);
            });
          }

          function getPayload() {
            if (createState.items.length === 0)
              throw new Error("Bitte mindestens ein Produkt hinzuf√ºgen.");
            if (!createState.paymentMethodId)
              throw new Error("Bitte eine Zahlungsmethode w√§hlen.");
            const items = createState.items.map((it) => ({
              productId: it.productId,
              quantity: it.qty,
              label: it.name,
            }));
            const shipCost =
              parseFloat(document.getElementById("shipPrice").value || "0") ||
              0;
            const base = {
              paymentMethodId: createState.paymentMethodId,
              items,
              shippingMethodId: createState.shippingMethodId,
              shippingCosts: shipCost,
            };
            if (createState.existing) {
              if (!createState.customerId)
                throw new Error("Bitte Kunden ausw√§hlen.");
              return { customerId: createState.customerId, ...base };
            }
            const g = createState.guest;
            if (!g.email || !g.firstName || !g.lastName)
              throw new Error("Gastdaten unvollst√§ndig.");
            const b = g.billing;
            if (!b.countryId || !b.street || !b.city)
              throw new Error("Rechnungsadresse unvollst√§ndig.");
            const s = g.shippingSame ? b : g.shipping;
            return {
              customer: {
                email: g.email,
                firstName: g.firstName,
                lastName: g.lastName,
                salutationId: g.salutationId || undefined,
                billingAddress: {
                  street: b.street,
                  zipcode: b.zipcode,
                  city: b.city,
                  countryId: b.countryId,
                },
                shippingAddress: {
                  street: s.street,
                  zipcode: s.zipcode,
                  city: s.city,
                  countryId: s.countryId || b.countryId,
                },
              },
              ...base,
            };
          }

          // Wire events
          cust.querySelectorAll('input[name="custMode"]').forEach((r) =>
            r.addEventListener("change", () => {
              createState.existing = r.value === "existing";
              document.getElementById("custExisting").style.display =
                createState.existing ? "block" : "none";
              document.getElementById("custGuest").style.display =
                createState.existing ? "none" : "block";
            })
          );
          document.getElementById("gSame").addEventListener("change", (e) => {
            const on = e.target.checked;
            createState.guest.shippingSame = on;
            document.getElementById("shipBlock").style.display = on
              ? "none"
              : "block";
          });
          document.getElementById("custQ").addEventListener("input", (e) => {
            const q = e.target.value.trim();
            clearTimeout(window.__custDeb);
            window.__custDeb = setTimeout(() => q && searchCustomers(q), 250);
          });
          document.getElementById("pQ").addEventListener("input", (e) => {
            const q = e.target.value.trim();
            clearTimeout(window.__prodDeb);
            window.__prodDeb = setTimeout(() => q && searchProducts(q), 250);
          });

          // Guest field bindings
          const bind = (id, obj, key) =>
            document
              .getElementById(id)
              .addEventListener("input", (e) => (obj[key] = e.target.value));
          bind("gEmail", createState.guest, "email");
          bind("gFirst", createState.guest, "firstName");
          bind("gLast", createState.guest, "lastName");
          bind("gBStreet", createState.guest.billing, "street");
          bind("gBZip", createState.guest.billing, "zipcode");
          bind("gBCity", createState.guest.billing, "city");
          document
            .getElementById("gBCountry")
            .addEventListener(
              "change",
              (e) => (createState.guest.billing.countryId = e.target.value)
            );
          bind("gSStreet", createState.guest.shipping, "street");
          bind("gSZip", createState.guest.shipping, "zipcode");
          bind("gSCity", createState.guest.shipping, "city");
          document
            .getElementById("gSCountry")
            .addEventListener(
              "change",
              (e) => (createState.guest.shipping.countryId = e.target.value)
            );

          // Submit
          createBtn.addEventListener("click", async () => {
            errBox.style.display = "none";
            errBox.textContent = "";
            try {
              createBtn.disabled = true;
              createBtn.textContent = "Legt an‚Ä¶";
              showBusy("Bestellung wird angelegt‚Ä¶");
              const payload = getPayload();
              const r = await api.createOrder(payload);
              if (!r || !r.ok)
                throw new Error((r && r.error) || "Fehler beim Anlegen");
              openOrder(r.data.id);
            } catch (e) {
              errBox.textContent = String(e.message || e);
              errBox.style.display = "block";
            } finally {
              createBtn.disabled = false;
              createBtn.textContent = "Bestellung anlegen";
              hideBusy();
            }
          });
          backBtn.addEventListener("click", () => setTab("orders"));

          // Initial loads
          loadPaymentMethods();
          loadCountries();
          loadShippingMethods();
          loadSalutations();
          recompute();
        }

        // Global search across all tabs
        async function doGlobalSearch() {
          const q = (state.q || "").trim();
          if (!q) {
            state.searchMode = false;
            routeEl.innerHTML = "";
            renderListSkeleton();
            return loadMore();
          }
          try {
            const [prod, ord, cust] = await Promise.all([
              api.list("products", { page: 1, limit: 10, q }),
              api.list("orders", { page: 1, limit: 10, q }),
              api.list("customers", { page: 1, limit: 10, q }),
            ]);
            const wrap = el("div");
            wrap.appendChild(
              el("div", "section-title", `Suchergebnisse f√ºr ‚Äû${q}‚Äù`)
            );
            const addSection = (title, items, renderFn, emptyTxt) => {
              const card = el("div", "card");
              card.appendChild(el("div", "muted", title));
              card.style.marginBottom = "12px";
              const list = el("div", "list");
              if (items && items.length) {
                items.forEach((x) => list.appendChild(renderFn(x)));
              } else list.appendChild(el("div", "muted", emptyTxt));
              card.appendChild(list);
              wrap.appendChild(card);
            };
            addSection(
              "Produkte",
              prod.data || [],
              productItem,
              "Keine Produkte gefunden."
            );
            addSection(
              "Bestellungen",
              ord.data || [],
              orderItem,
              "Keine Bestellungen gefunden."
            );
            addSection(
              "Kunden",
              cust.data || [],
              customerItem,
              "Keine Kunden gefunden."
            );
            routeEl.innerHTML = "";
            routeEl.appendChild(wrap);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Suche fehlgeschlagen.</div>`;
          }
        }

        // Scroll-based infinite loading
        window.addEventListener(
          "scroll",
          () => {
            const nearBottom =
              window.innerHeight + window.scrollY >=
              document.body.offsetHeight - 200;
            if (nearBottom && !state.searchMode) loadMore();
          },
          { passive: true }
        );

        // Search
        $("#q").addEventListener("input", (e) => {
          state.q = e.target.value.trim();
          state.pages[state.tab] = 1;
          state.done[state.tab] = false;
          clearTimeout(window.__qdeb);
          if (state.q) {
            state.searchMode = true;
            routeEl.innerHTML = "";
            renderListSkeleton();
            window.__qdeb = setTimeout(() => doGlobalSearch(), 250);
          } else {
            state.searchMode = false;
            routeEl.innerHTML = "";
            renderListSkeleton();
            window.__qdeb = setTimeout(() => loadMore(), 100);
          }
        });
        $("#qClear").addEventListener("click", () => {
          $("#q").value = "";
          $("#q").dispatchEvent(new Event("input"));
        });

        // Tabs
        tabs.forEach((t) =>
          t.addEventListener("click", () => setTab(t.dataset.tab))
        );

        // Login handlers
        $("#togglePw").addEventListener("click", () => {
          const inp = $("#password");
          inp.type = inp.type === "password" ? "text" : "password";
        });
        $("#loginBtn").addEventListener("click", doLogin);
        $("#password").addEventListener("keydown", (e) => {
          if (e.key === "Enter") doLogin();
        });

        async function doLogin() {
          const pw = $("#password").value;
          $("#loginErr").style.display = "none";
          try {
            await api.login(pw);
            await boot();
          } catch (e) {
            $("#loginErr").textContent = "Falsches Passwort.";
            $("#loginErr").style.display = "block";
          }
        }

        function showLogin() {
          $("#shell").style.display = "none";
          $("#login").style.display = "grid";
        }
        function showApp() {
          $("#login").style.display = "none";
          $("#shell").style.display = "block";
        }

        async function boot() {
          const me = await api.me();
          if (me && me.ok) {
            try {
              state.features = await api.features();
            } catch {}
            showApp();
            setTab("products");
          } else {
            showLogin();
          }
        }
        boot();
      })();
    </script>
  </body>
</html>
