<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>Shopware Mobile Admin</title>
    <meta name="theme-color" content="#0a0a0a" />
    <style>
      :root {
        --bg: #0b0c0f;
        --card: #14161b;
        --muted: #8a8f98;
        --txt: #f5f7fb;
        --acc: #3aa0ff;
        --danger: #ff5555;
        --ok: #28c081;
        --radius: 18px;
        --pad: 14px;
        --gap: 12px;
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--txt);
        font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter,
          Ubuntu, sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      .app {
        min-height: 100%;
        display: flex;
        flex-direction: column;
      }
      header.nav {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(
          180deg,
          rgba(11, 12, 15, 0.95),
          rgba(11, 12, 15, 0.85)
        );
        backdrop-filter: blur(10px);
        padding: 12px 14px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      header.nav .row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
      }
      .logo .dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--ok);
        box-shadow: 0 0 18px var(--ok);
      }
      .search {
        flex: 1;
        display: flex;
        align-items: center;
        background: var(--card);
        border-radius: 999px;
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .search input {
        flex: 1;
        background: transparent;
        color: var(--txt);
        border: 0;
        outline: none;
        font: inherit;
      }
      .search button {
        background: transparent;
        border: 0;
        color: var(--muted);
      }

      main {
        flex: 1;
        padding: 10px 12px calc(76px + env(safe-area-inset-bottom));
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .card {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: var(--pad);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .row {
        display: flex;
        gap: 10px;
      }
      .between {
        justify-content: space-between;
        align-items: center;
      }
      .muted {
        color: var(--muted);
      }
      .pill {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .pill.ok {
        color: #0e2;
        color: inherit;
        background: rgba(40, 192, 129, 0.12);
        border-color: rgba(40, 192, 129, 0.25);
      }
      .pill.bad {
        color: #e33;
        background: rgba(255, 85, 85, 0.12);
        border-color: rgba(255, 85, 85, 0.25);
      }
      .price {
        font-weight: 700;
      }
      .thumb {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        background: #0a0b0e center/cover no-repeat;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .tabs {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 8px;
        padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
        background: linear-gradient(
          180deg,
          rgba(11, 12, 15, 0.1),
          rgba(11, 12, 15, 0.85)
        );
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }
      .tab {
        flex: 1;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 9px 8px;
        text-align: center;
        color: var(--muted);
      }
      .tab.active {
        color: var(--txt);
        outline: 2px solid rgba(58, 160, 255, 0.25);
      }

      .section-title {
        margin: 12px 4px 6px;
        font-size: 13px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .skeleton {
        position: relative;
        overflow: hidden;
        background: #0e1014;
        border-radius: 12px;
        height: 64px;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .skeleton::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.06),
          transparent
        );
        animation: shimmer 1.1s infinite;
      }
      @keyframes shimmer {
        to {
          transform: translateX(100%);
        }
      }

      .banner {
        margin: 12px;
        color: #ffca66;
        background: rgba(255, 202, 102, 0.12);
        border: 1px dashed rgba(255, 202, 102, 0.35);
        padding: 10px;
        border-radius: 12px;
      }

      /* Login */
      .login {
        min-height: 100dvh;
        display: grid;
        place-items: center;
        padding: 20px;
      }
      .wall {
        width: min(480px, 100%);
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 22px;
        box-shadow: var(--shadow);
        padding: 22px;
      }
      .wall h1 {
        margin: 0 0 6px;
      }
      .wall p {
        margin: 0 0 14px;
        color: var(--muted);
      }
      .field {
        display: flex;
        background: #0c0e12;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        overflow: hidden;
      }
      .field input {
        flex: 1;
        background: transparent;
        border: 0;
        outline: none;
        color: var(--txt);
        padding: 12px;
      }
      .field button {
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 0 12px;
      }
      .cta {
        width: 100%;
        margin-top: 12px;
        background: var(--acc);
        border: 0;
        color: white;
        font-weight: 700;
        padding: 13px;
        border-radius: 14px;
      }
      .err {
        color: var(--danger);
        font-size: 13px;
        margin-top: 6px;
      }

      @media (min-width: 720px) {
        .desktop-info {
          display: block;
        }
      }
      @media (max-width: 719px) {
        .desktop-info {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- Login Wall -->
      <section class="login" id="login">
        <div style="position: relative; top: -80px; width: 300px">
          <img
            src="https://cobracards.loki.ambitive.de/media/5b/ae/5b/1754291920/Logo-CobraCards-Export-2.svg?ts=1754291920"
            width="200"
            height="auto"
            style="
              width: 200px;
              margin: 0 auto;
              display: block;
              margin-bottom: 40px;
            "
          />
          <div class="wall">
            <div class="row between" style="margin-bottom: 10px">
              <div class="logo">
                <span class="dot"></span><span>CC Admin</span>
              </div>
              <span class="muted" id="versionTag">v1</span>
            </div>
            <h1>Willkommen</h1>
            <p>Bitte Passwort eingeben, um das Shopware‚ÄëDashboard zu √∂ffnen.</p>
            <div class="field">
              <input
                id="password"
                type="password"
                placeholder="Passwort"
                autocomplete="current-password"
              />
              <button
                type="button"
                id="togglePw"
                aria-label="Passwort anzeigen"
              >
                üëÅÔ∏è
              </button>
            </div>
            <button class="cta" id="loginBtn">Anmelden</button>
            <div
              class="err"
              id="loginErr"
              role="alert"
              style="display: none"
            ></div>
          </div>
        </div>
      </section>

      <!-- App Shell -->
      <section id="shell" style="display: none">
        <header class="nav">
          <div class="row between">
            <div class="logo">
              <span class="dot"></span><span>CC Admin</span>
            </div>
            <div class="search" role="search">
              <input
                id="q"
                placeholder="Produkte, Bestellungen, Kunden suchen‚Ä¶"
                inputmode="search"
              />
              <button id="qClear" aria-label="L√∂schen">‚úï</button>
            </div>
          </div>
        </header>

        <main>
          <div id="route"></div>
        </main>

        <nav class="tabs" role="tablist" aria-label="Main">
          <button class="tab active" data-tab="products" aria-selected="true">
            üõçÔ∏è
            <div>Produkte</div>
          </button>
          <button class="tab" data-tab="orders">
            üßæ
            <div>Bestellungen</div>
          </button>
          <button class="tab" data-tab="customers">
            üë§
            <div>Kunden</div>
          </button>
          <button class="tab" data-tab="settings">
            ‚öôÔ∏è
            <div>Einstellungen</div>
          </button>
        </nav>
      </section>
    </div>

    <script>
      (function () {
        const $ = (sel) => document.querySelector(sel);
        const routeEl = $("#route");
        const tabs = document.querySelectorAll(".tab");

        const state = {
          tab: "products",
          q: "",
          pages: { products: 1, orders: 1, customers: 1 },
          loading: false,
          done: { products: false, orders: false, customers: false },
        };

        const api = {
          async me() {
            try {
              const r = await fetch("/api/me");
              return await r.json();
            } catch (e) {
              return { ok: false };
            }
          },
          async login(password) {
            const r = await fetch("/api/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password }),
            });
            if (!r.ok) throw new Error("Ung√ºltiges Passwort");
            return r.json();
          },
          async logout() {
            await fetch("/api/logout", { method: "POST" });
          },
          async list(kind, { page = 1, limit = 20, q = "" }) {
            const params = new URLSearchParams({ page, limit, q });
            const r = await fetch(`/api/${kind}?` + params);
            if (r.status === 401) {
              showLogin();
              return { data: [], total: 0 };
            }
            if (!r.ok) throw new Error("Laden fehlgeschlagen");
            return await r.json();
          },
          async product(id) {
            const r = await fetch(`/api/products/${id}`);
            if (!r.ok) throw new Error("Nicht gefunden");
            return await r.json();
          },
          async order(id) {
            const r = await fetch(`/api/orders/${id}`);
            if (!r.ok) throw new Error("Nicht gefunden");
            return await r.json();
          },
          async ordersMetrics() {
            const r = await fetch(`/api/orders/metrics`);
            if (!r.ok) throw new Error("Laden fehlgeschlagen");
            return await r.json();
          },
          async customer(id) {
            const r = await fetch(`/api/customers/${id}`);
            if (!r.ok) throw new Error("Nicht gefunden");
            return await r.json();
          },
          async customerOrders(id, { page = 1, limit = 20 } = {}) {
            const params = new URLSearchParams({ page, limit });
            const r = await fetch(`/api/customers/${id}/orders?` + params);
            if (!r.ok) throw new Error("Failed to load");
            return await r.json();
          },
        };

        // UI helpers
        function setTab(tab) {
          state.tab = tab;
          tabs.forEach((t) =>
            t.classList.toggle("active", t.dataset.tab === tab)
          );
          $("#q").value = state.q = "";
          routeEl.innerHTML = "";
          state.pages[tab] = 1;
          state.done[tab] = false;
          renderListSkeleton();
          loadMore();
        }

        function renderListSkeleton() {
          const wrap = document.createElement("div");
          wrap.className = "list";
          for (let i = 0; i < 8; i++) {
            const s = document.createElement("div");
            s.className = "skeleton";
            wrap.appendChild(s);
          }
          routeEl.innerHTML = "";
          routeEl.appendChild(wrap);
        }

        function el(tag, cls, html) {
          const e = document.createElement(tag);
          if (cls) e.className = cls;
          if (html !== undefined) e.innerHTML = html;
          return e;
        }

        function money(n, c = "‚Ç¨") {
          if (n == null) return "";
          return new Intl.NumberFormat(undefined, {
            style: "currency",
            currencyDisplay: "symbol",
            currency: "EUR",
          }).format(n);
        }

        function productItem(p) {
          const card = el("div", "card");
          const row = el("div", "row between");
          const left = el("div", "row");
          const img = el("div", "thumb");
          if (p.img) img.style.backgroundImage = `url("${p.img}")`;
          left.appendChild(img);
          const info = el("div");
          info.innerHTML = `<div style="font-weight:600"><p style="margin:0;margin: 0;
    max-width: 190px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;">${
      p.name || "(kein Name)"
    }</p><p class="muted" style="margin:0px">#${p.productNumber || ""}</p></div>
      <div class="muted" style="font-size:13px">${p.manufacturer || "‚Äî"}</div>`;
          left.appendChild(info);
          const right = el("div", "row");
          right.style.alignItems = "end";
          right.style.flexDirection = "column";
          const price = el("div", "price", p.price ? money(p.price) : "");
          const stock = el(
            "div",
            "pill " + (p.active ? "ok" : "bad"),
            p.active ? `Auf Lager: ${p.stock}` : "Inaktiv"
          );
          right.append(price, stock);
          row.append(left, right);
          card.appendChild(row);
          card.addEventListener("click", () => openProduct(p.id));
          return card;
        }

        function orderItem(o) {
          const card = el("div", "card");
          card.innerHTML = `<div class="row between">
      <div>
        <div style="font-weight:600">Bestellung #${o.orderNumber}</div>
        <div class="muted" style="font-size:13px">${new Date(
          o.createdAt
        ).toLocaleString()} ‚Ä¢ ${o.customerEmail || ""}</div>
      </div>
      <div style="text-align:right">
        <div class="price">${money(o.amountTotal)}</div>
        <div class="pill ${o.stateColor || "ok"}">${o.state || "‚Äî"}</div>
      </div>
    </div>`;
          card.addEventListener("click", () => openOrder(o.id));
          return card;
        }

        function customerItem(c) {
          const card = el("div", "card");
          card.innerHTML = `<div class="row between">
      <div>
        <div style="font-weight:600">${c.firstName || ""} ${
            c.lastName || ""
          }</div>
        <div class="muted" style="font-size:13px">${c.email || ""}</div>
      </div>
      <div class="pill ${c.active ? "ok" : "bad"}">${
            c.active ? "Aktiv" : "Inaktiv"
          }</div>
    </div>`;
          card.addEventListener("click", () => openCustomer(c.id));
          return card;
        }

        async function openProduct(id) {
          routeEl.innerHTML = "";
          routeEl.appendChild(el("div", "skeleton"));
          try {
            const { data: p } = await api.product(id);
            const card = el("div", "card");
            card.innerHTML = `
        <div class="row" style="gap:14px">
          <div class="thumb" style="width:100px;height:100px;background-size:cover;${
            p.img ? `background-image:url('${p.img}')` : ""
          }"></div>
          <div>
            <div style="font-weight:700;font-size:18px">${
              p.name || "(kein Name)"
            } </div>
            <div class="muted" style="margin-top:2px">#${
              p.productNumber || ""
            }</div>
            <div class="row" style="margin-top:8px;gap:8px">
              <div class="pill ${p.active ? "ok" : "bad"}">${
              p.active ? "Aktiv" : "Inaktiv"
            }</div>
              <div class="pill">Bestand: ${p.stock ?? "‚Äî"}</div>
            </div>
          </div>
        </div>
        <div class="row between" style="margin-top:12px">
          <div>
            <div class="muted">Hersteller</div>
            <div>${p.manufacturer || "‚Äî"}</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Preis</div>
            <div class="price">${p.price ? money(p.price) : "‚Äî"}</div>
          </div>
        </div>
      `;
            const back = el("button", "cta");
            back.textContent = "‚Üê Zur√ºck";
            back.style.marginTop = "12px";
            back.addEventListener("click", () => setTab("products"));
            routeEl.innerHTML = "";
            routeEl.append(card, back);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Produkt konnte nicht geladen werden.</div>`;
          }
        }

        async function openOrder(id) {
          routeEl.innerHTML = "";
          routeEl.appendChild(el("div", "skeleton"));
          try {
            const { data: o } = await api.order(id);
            const card = el("div", "card");
            const items = (o.items || [])
              .map(
                (i) => `<div class="row between" style="margin-top:8px">
          <div class="row" style="gap:8px;align-items:center">
            <div class="thumb" style="width:44px;height:44px;${
              i.img ? `background-image:url('${i.img}')` : ""
            }"></div>
            <div>${i.label || ""}</div>
          </div>
          <div class="muted">x${i.qty || 1}</div>
        </div>`
              )
              .join("");
            const paidPill = `<span class="pill ${o.paid ? "ok" : "bad"}">${
              o.paid ? "Bezahlt" : o.paidState || "Unbezahlt"
            }</span>`;
            const shippedPill = `<span class="pill ${
              o.shipped ? "ok" : "bad"
            }">${
              o.shipped ? "Versendet" : o.shippedState || "Nicht versendet"
            }</span>`;
            card.innerHTML = `
        <div class="row between">
          <div>
            <div style="font-weight:700">Bestellung #${o.orderNumber}</div>
            <div class="muted" style="font-size:13px">${new Date(
              o.createdAt
            ).toLocaleString()} ‚Ä¢ ${o.customerEmail || ""}</div>
          </div>
          <div style="text-align:right">
            <div class="pill ${o.stateColor || "ok"}">${o.state || "‚Äî"}</div>
            <div class="price">${money(o.amountTotal)}</div>
          </div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">${paidPill}${shippedPill}</div>
        <div style="margin-top:10px">${
          items || '<div class="muted">Keine Positionen</div>'
        }</div>
      `;
            const buttons = el("div", "row");
            buttons.style.flexWrap = "wrap";
            buttons.style.gap = "8px";
            buttons.style.marginTop = "12px";
            const invoiceBtn = el("button", "cta");
            invoiceBtn.textContent = "Rechnung erstellen";
            invoiceBtn.addEventListener("click", async () => {
              try {
                invoiceBtn.disabled = true;
                const old = invoiceBtn.textContent;
                invoiceBtn.textContent = "Erstelle‚Ä¶";
                const r = await fetch(`/api/orders/${id}/invoice`, {
                  method: "POST",
                });
                if (!r.ok) throw new Error("Fehler beim Erstellen");
                const j = await r.json();
                invoiceBtn.textContent = "Rechnung herunterladen";
                invoiceBtn.disabled = false;
                if (j && j.downloadUrl) {
                  window.open(j.downloadUrl, "_blank");
                }
              } catch (e) {
                invoiceBtn.disabled = false;
                invoiceBtn.textContent = "Rechnung erstellen";
                alert("Rechnung konnte nicht erstellt werden.");
              }
            });

            const invoiceMailBtn = el("button", "cta");
            invoiceMailBtn.textContent =
              "Rechnung erstellen und an den Kunden senden";
            invoiceMailBtn.addEventListener("click", async () => {
              try {
                invoiceMailBtn.disabled = true;
                const old = invoiceMailBtn.textContent;
                invoiceMailBtn.textContent = "Sende‚Ä¶";
                const r = await fetch(`/api/orders/${id}/invoice-email`, {
                  method: "POST",
                });
                if (!r.ok) throw new Error("Fehler beim Senden");
                await r.json();
                invoiceMailBtn.textContent = "Gesendet";
                setTimeout(() => {
                  invoiceMailBtn.textContent = old;
                  invoiceMailBtn.disabled = false;
                }, 1500);
              } catch (e) {
                invoiceMailBtn.disabled = false;
                alert("Rechnung konnte nicht gesendet werden.");
              }
            });

            const back = el("button", "cta");
            back.textContent = "‚Üê Zur√ºck";
            back.addEventListener("click", () => setTab("orders"));
            buttons.appendChild(invoiceBtn);
            buttons.appendChild(invoiceMailBtn);
            if (o.customerId) {
              const toCustomer = el("button", "cta");
              toCustomer.textContent = "Zum Kunden";
              toCustomer.addEventListener("click", () =>
                openCustomer(o.customerId)
              );
              buttons.appendChild(toCustomer);
            }
            buttons.appendChild(back);
            routeEl.innerHTML = "";
            routeEl.append(card, buttons);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Bestellung konnte nicht geladen werden.</div>`;
          }
        }

        async function openCustomer(id) {
          routeEl.innerHTML = "";
          routeEl.appendChild(el("div", "skeleton"));
          try {
            const { data: c } = await api.customer(id);
            const card = el("div", "card");
            card.innerHTML = `
        <div class="row between">
          <div>
            <div style="font-weight:700">${c.firstName || ""} ${
              c.lastName || ""
            }</div>
            <div class="muted" style="font-size:13px">${c.email || ""}</div>
          </div>
          <div class="pill ${c.active ? "ok" : "bad"}">${
              c.active ? "Active" : "Inactive"
            }</div>
        </div>
        <div class="row between" style="margin-top:12px">
          <div class="muted">Customer #</div>
          <div>${c.customerNumber || "‚Äî"}</div>
        </div>
        <div class="row between" style="margin-top:6px">
          <div class="muted">Created</div>
          <div>${
            c.createdAt ? new Date(c.createdAt).toLocaleString() : "‚Äî"
          }</div>
        </div>
      `;
            const ordersWrap = el("div", "card");
            ordersWrap.innerHTML = `<div class="section-title">Bestellungen</div>`;
            const list = el("div", "list");
            ordersWrap.appendChild(list);
            // Load orders list
            try {
              const { data: orders } = await api.customerOrders(id, {
                page: 1,
                limit: 50,
              });
              if (orders.length === 0) {
                list.appendChild(
                  el("div", "muted", "Noch keine Bestellungen.")
                );
              } else {
                orders.forEach((o) => list.appendChild(orderItem(o)));
              }
            } catch (e) {
              list.appendChild(
                el("div", "muted", "Bestellungen konnten nicht geladen werden.")
              );
            }

            const back = el("button", "cta");
            back.textContent = "‚Üê Zur√ºck";
            back.style.marginTop = "12px";
            back.addEventListener("click", () => setTab("customers"));
            routeEl.innerHTML = "";
            routeEl.append(card, ordersWrap, back);
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Kunde konnte nicht geladen werden.</div>`;
          }
        }

        async function loadMore() {
          if (state.loading || state.done[state.tab]) return;
          state.loading = true;
          try {
            const page = state.pages[state.tab];
            const { data, total } = await api.list(state.tab, {
              page,
              limit: 20,
              q: state.q,
            });
            let list = routeEl.querySelector(".list");
            if (!list) {
              list = el("div", "list");
              routeEl.innerHTML = "";
              routeEl.appendChild(list);
            }
            // Ensure metrics card exists for orders (even if skeleton list already existed)
            if (
              state.tab === "orders" &&
              !document.getElementById("orderMetrics")
            ) {
              const m = el("div", "card");
              m.id = "orderMetrics";
              m.innerHTML = `
                <div class="section-title">Kennzahlen</div>
                <div class="row" style="gap:8px;flex-wrap:wrap">
                  <div class="pill" id="mToday">Heute: ‚Ä¶</div>
                  <div class="pill" id="m7">Letzte 7 Tage: ‚Ä¶</div>
                  <div class="pill" id="m30">Letzte 30 Tage: ‚Ä¶</div>
                  <div class="pill" id="mYear">Dieses Jahr: ‚Ä¶</div>
                </div>`;
              m.style.marginBottom = "12px";
              routeEl.insertBefore(m, list);
              // Load metrics async
              api
                .ordersMetrics()
                .then(({ today, last7, last30, thisYear }) => {
                  const set = (id, txt) => {
                    const n = document.getElementById(id);
                    if (n) n.textContent = txt;
                  };
                  const fmt = (m) => `${m.count} ‚Ä¢ ${money(m.amount)}`;
                  set("mToday", `Heute: ${fmt(today)}`);
                  set("m7", `Letzte 7 Tage: ${fmt(last7)}`);
                  set("m30", `Letzte 30 Tage: ${fmt(last30)}`);
                  set("mYear", `Dieses Jahr: ${fmt(thisYear)}`);
                })
                .catch(() => {
                  const n = document.getElementById("orderMetrics");
                  if (n) n.style.display = "none";
                });
            }
            // Clear skeletons on first real data load
            const sk = list.querySelector(".skeleton");
            if (sk) list.innerHTML = "";
            if (state.tab === "products") {
              data.forEach((p) => list.appendChild(productItem(p)));
            }
            if (state.tab === "orders") {
              data.forEach((o) => list.appendChild(orderItem(o)));
            }
            if (state.tab === "customers") {
              data.forEach((c) => list.appendChild(customerItem(c)));
            }
            const soFar = page * 20;
            if (soFar >= total || data.length === 0) {
              state.done[state.tab] = true;
            } else {
              state.pages[state.tab]++;
            }
          } catch (e) {
            routeEl.innerHTML = `<div class='card'>Fehler beim Laden der Daten.</div>`;
          } finally {
            state.loading = false;
          }
        }

        // Scroll-based infinite loading
        window.addEventListener(
          "scroll",
          () => {
            const nearBottom =
              window.innerHeight + window.scrollY >=
              document.body.offsetHeight - 200;
            if (nearBottom) loadMore();
          },
          { passive: true }
        );

        // Search
        $("#q").addEventListener("input", (e) => {
          state.q = e.target.value.trim();
          state.pages[state.tab] = 1;
          state.done[state.tab] = false;
          routeEl.innerHTML = "";
          renderListSkeleton();
          clearTimeout(window.__qdeb);
          window.__qdeb = setTimeout(() => loadMore(), 300);
        });
        $("#qClear").addEventListener("click", () => {
          $("#q").value = "";
          $("#q").dispatchEvent(new Event("input"));
        });

        // Tabs
        tabs.forEach((t) =>
          t.addEventListener("click", () => setTab(t.dataset.tab))
        );

        // Login handlers
        $("#togglePw").addEventListener("click", () => {
          const inp = $("#password");
          inp.type = inp.type === "password" ? "text" : "password";
        });
        $("#loginBtn").addEventListener("click", doLogin);
        $("#password").addEventListener("keydown", (e) => {
          if (e.key === "Enter") doLogin();
        });

        async function doLogin() {
          const pw = $("#password").value;
          $("#loginErr").style.display = "none";
          try {
            await api.login(pw);
            await boot();
          } catch (e) {
            $("#loginErr").textContent = "Falsches Passwort.";
            $("#loginErr").style.display = "block";
          }
        }

        function showLogin() {
          $("#shell").style.display = "none";
          $("#login").style.display = "grid";
        }
        function showApp() {
          $("#login").style.display = "none";
          $("#shell").style.display = "block";
        }

        async function boot() {
          const me = await api.me();
          if (me && me.ok) {
            showApp();
            setTab("products");
          } else {
            showLogin();
          }
        }
        boot();
      })();
    </script>
  </body>
</html>
